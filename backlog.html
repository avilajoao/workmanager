<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backlog - WorkManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#8B5CF6",
                        darkBg: "#121212",
                        darkPanel: "#1E1E1E",
                        darkBorder: "#292929",
                        grayText: "#A1A1A1",
                        lightBg: "#F5F5F5",
                        lightPanel: "#FFFFFF",
                        lightText: "#333333",
                        lightBorder: "#DDDDDD"
                    }
                }
            }
        };
    </script>
    <style>
        .sidebar {
            width: 5rem;
            transition: width 0.3s ease;
        }
        .sidebar.expanded {
            width: 15rem;
        }
        .panel {
            background-color: #1E1E1E;
            border-color: #292929;
        }
        .priority-urgent {
            background-color: rgba(239, 68, 68, 0.2);
            color: rgb(252, 165, 165);
            border-color: rgb(239, 68, 68);
        }
        .priority-high {
            background-color: rgba(249, 115, 22, 0.2);
            color: rgb(253, 186, 116);
            border-color: rgb(249, 115, 22);
        }
        .priority-medium {
            background-color: rgba(234, 179, 8, 0.2);
            color: rgb(253, 224, 71);
            border-color: rgb(234, 179, 8);
        }
        .priority-low {
            background-color: rgba(34, 197, 94, 0.2);
            color: rgb(134, 239, 172);
            border-color: rgb(34, 197, 94);
        }
        .kanban-column {
            background-color: rgba(18, 18, 18, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }
        .task-card {
            background-color: #1E1E1E;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #292929;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition-property: color, background-color, border-color;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        .task-card:hover {
            border-color: #8B5CF6;
        }
    </style>
</head>
<body class="bg-darkBg text-white font-sans transition-all duration-300">

    <!-- Container Principal -->
    <div class="flex h-screen">

        <!-- Sidebar -->
        <aside class="sidebar bg-darkPanel flex flex-col items-center py-6 border-r border-darkBorder">
            <button id="toggleSidebar" class="text-grayText text-2xl mb-6">
                <i class="ph ph-list"></i>
            </button>
            <nav class="flex flex-col space-y-6">
                <a href="home.html" class="text-grayText hover:text-white text-2xl">
                    <i class="ph ph-house"></i>
                    <span class="hidden ml-3 text-base">Início</span>
                </a>
                <a href="backlog.html" class="text-primary hover:text-white text-2xl">
                    <i class="ph ph-kanban"></i>
                    <span class="hidden ml-3 text-base">Backlog</span>
                </a>
                <a href="projects.html" class="text-grayText hover:text-white text-2xl">
                    <i class="ph ph-buildings"></i>
                    <span class="hidden ml-3 text-base">Projetos</span>
                </a>
                <a href="settings.html" class="text-grayText hover:text-white text-2xl">
                    <i class="ph ph-gear"></i>
                    <span class="hidden ml-3 text-base">Configurações</span>
                </a>
            </nav>
            <div class="mt-auto">
                <button id="logoutBtn" class="text-grayText hover:text-white text-2xl">
                    <i class="ph ph-sign-out"></i>
                    <span class="hidden ml-3 text-base">Sair</span>
                </button>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-8 overflow-y-auto">

            <!-- Header -->
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-semibold">Backlog</h1>
                    <p class="text-grayText" id="current-date"></p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="toggleDarkMode" class="bg-transparent text-2xl">
                        <i class="ph ph-moon"></i>
                    </button>
                    <div class="relative" id="userProfile">
                        <button class="flex items-center space-x-2 bg-darkPanel px-3 py-2 rounded-lg border border-darkBorder">
                            <span id="userInitials" class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center font-medium"></span>
                            <span id="userName">Carregando...</span>
                            <i class="ph ph-caret-down text-grayText"></i>
                        </button>
                        <!-- Dropdown menu -->
                        <div class="absolute right-0 mt-2 w-48 bg-darkPanel border border-darkBorder rounded-lg shadow-lg hidden dropdown-menu" id="userDropdown">
                            <ul class="py-2">
                                <li><a href="profile.html" class="block px-4 py-2 hover:bg-darkBorder">Meu Perfil</a></li>
                                <li><a href="settings.html" class="block px-4 py-2 hover:bg-darkBorder">Configurações</a></li>
                                <li><hr class="my-1 border-darkBorder"></li>
                                <li><button id="logoutBtnDropdown" class="block w-full text-left px-4 py-2 hover:bg-darkBorder text-red-400">Sair</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Barra de ferramentas -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex space-x-2">
                    <div class="relative">
                        <input type="text" id="searchTasks" placeholder="Buscar tarefas..." 
                            class="bg-darkPanel border border-darkBorder rounded-lg px-4 py-2 pl-10 focus:outline-none focus:border-primary">
                        <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-grayText"></i>
                    </div>
                    <select id="filterProject" class="bg-darkPanel border border-darkBorder rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                        <option value="">Todos os projetos</option>
                        <!-- Opções serão preenchidas via JavaScript -->
                    </select>
                    <select id="filterPriority" class="bg-darkPanel border border-darkBorder rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                        <option value="">Todas as prioridades</option>
                        <option value="urgent">Urgente</option>
                        <option value="high">Alta</option>
                        <option value="medium">Média</option>
                        <option value="low">Baixa</option>
                    </select>
                </div>
                <button id="newTaskBtn" class="bg-primary hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="ph ph-plus mr-2"></i> Nova Tarefa
                </button>
            </div>

            <!-- Kanban Board -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Coluna: A Fazer -->
                <div class="kanban-column" id="todo-column">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg">A Fazer</h2>
                        <span class="bg-darkPanel px-2 py-1 rounded-full text-xs" id="todo-count">0</span>
                    </div>
                    <div class="task-list flex-1" id="todo-tasks">
                        <div class="animate-pulse">
                            <div class="bg-darkPanel border border-darkBorder rounded-lg p-4 mb-3 h-24"></div>
                            <div class="bg-darkPanel border border-darkBorder rounded-lg p-4 mb-3 h-24"></div>
                        </div>
                    </div>
                </div>

                <!-- Coluna: Em Andamento -->
                <div class="kanban-column" id="in-progress-column">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg">Em Andamento</h2>
                        <span class="bg-darkPanel px-2 py-1 rounded-full text-xs" id="in-progress-count">0</span>
                    </div>
                    <div class="task-list flex-1" id="in-progress-tasks">
                        <div class="animate-pulse">
                            <div class="bg-darkPanel border border-darkBorder rounded-lg p-4 mb-3 h-24"></div>
                        </div>
                    </div>
                </div>

                <!-- Coluna: Concluído -->
                <div class="kanban-column" id="done-column">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg">Concluído</h2>
                        <span class="bg-darkPanel px-2 py-1 rounded-full text-xs" id="done-count">0</span>
                    </div>
                    <div class="task-list flex-1" id="done-tasks">
                        <div class="animate-pulse">
                            <div class="bg-darkPanel border border-darkBorder rounded-lg p-4 mb-3 h-24"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Nova Tarefa -->
            <div id="taskModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
                <div class="bg-darkPanel border border-darkBorder rounded-lg p-6 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold" id="taskModalTitle">Nova Tarefa</h2>
                        <button id="closeTaskModal" class="text-grayText hover:text-white">
                            <i class="ph ph-x text-xl"></i>
                        </button>
                    </div>
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        <div class="mb-4">
                            <label for="taskTitle" class="block text-grayText mb-1">Título</label>
                            <input type="text" id="taskTitle" name="title" required
                                class="w-full bg-darkBg border border-darkBorder rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                        </div>
                        <div class="mb-4">
                            <label for="taskDescription" class="block text-grayText mb-1">Descrição</label>
                            <textarea id="taskDescription" name="description" rows="3"
                                class="w-full bg-darkBg border border-darkBorder rounded-lg px-4 py-2 focus:outline-none focus:border-primary"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="taskProject" class="block text-grayText mb-1">Projeto</label>
                            <select id="taskProject" name="projectId" required
                                class="w-full bg-darkBg border border-darkBorder rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                                <option value="">Selecione um projeto</option>
                                <!-- Opções serão preenchidas via JavaScript -->
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="taskPriority" class="block text-grayText mb-1">Prioridade</label>
                                <select id="taskPriority" name="priority"
                                    class="w-full bg-darkBg border border-darkBorder rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                                    <option value="low">Baixa</option>
                                    <option value="medium" selected>Média</option>
                                    <option value="high">Alta</option>
                                    <option value="urgent">Urgente</option>
                                </select>
                            </div>
                            <div>
                                <label for="taskStatus" class="block text-grayText mb-1">Status</label>
                                <select id="taskStatus" name="status"
                                    class="w-full bg-darkBg border border-darkBorder rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                                    <option value="todo">A Fazer</option>
                                    <option value="in-progress">Em Andamento</option>
                                    <option value="done">Concluído</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="taskDueDate" class="block text-grayText mb-1">Data de Entrega</label>
                            <input type="date" id="taskDueDate" name="dueDate"
                                class="w-full bg-darkBg border border-darkBorder rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" id="cancelTask"
                                class="px-4 py-2 border border-darkBorder rounded-lg hover:bg-darkBorder">
                                Cancelar
                            </button>
                            <button type="submit" id="saveTaskBtn"
                                class="bg-primary hover:bg-purple-600 text-white px-4 py-2 rounded-lg">
                                Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal de Detalhes da Tarefa -->
            <div id="taskDetailsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
                <div class="bg-darkPanel border border-darkBorder rounded-lg p-6 w-full max-w-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold" id="detailsTaskTitle">Detalhes da Tarefa</h2>
                        <button id="closeTaskDetailsModal" class="text-grayText hover:text-white">
                            <i class="ph ph-x text-xl"></i>
                        </button>
                    </div>








                    <div id="taskDetailsContent">
                        <div class="animate-pulse">
                            <div class="h-6 bg-darkBg rounded w-3/4 mb-4"></div>
                            <div class="h-4 bg-darkBg rounded w-1/2 mb-2"></div>
                            <div class="h-4 bg-darkBg rounded w-full mb-4"></div>
                            <div class="h-32 bg-darkBg rounded w-full mb-4"></div>
                        </div>
                    </div>
                </div>
           </div>
        </main>
    </div>


    <!-- Scripts -->
    <script src="init-data.js"></script>
    <script src="api-mock.js"></script>
    <script src="auth.js"></script>
    <script src="theme.js"></script>
    <script src="sidebar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticação
            if (!auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Carregar dados do usuário
            const currentUser = auth.getCurrentUser();
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
                
                // Iniciais do usuário
                const initials = currentUser.name.split(' ')
                    .map(name => name[0])
                    .slice(0, 2)
                    .join('')
                    .toUpperCase();
                document.getElementById('userInitials').textContent = initials;
            }
            
            // Atualizar data
            updateCurrentDate();
            
            // Configurar eventos
            setupEventListeners();
            
            // Carregar projetos para o filtro e para o formulário
            await loadProjects();
            
            // Carregar tarefas
            await loadTasks();
        });
        
        // Atualizar data atual
        function updateCurrentDate() {
            const dateElement = document.getElementById('current-date');
            if (!dateElement) return;
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const currentDate = new Date().toLocaleDateString('pt-BR', options);
            
            dateElement.textContent = currentDate;
        }
        
        // Configurar eventos
        function setupEventListeners() {
            // Toggle user dropdown
            const userProfile = document.getElementById('userProfile');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userProfile && userDropdown) {
                userProfile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });
                
                // Fechar dropdown ao clicar fora
                document.addEventListener('click', () => {
                    userDropdown.classList.add('hidden');
                });
            }
            
            // Logout do dropdown
            const logoutBtnDropdown = document.getElementById('logoutBtnDropdown');
            if (logoutBtnDropdown) {
                logoutBtnDropdown.addEventListener('click', () => {
                    auth.logout();
                });
            }
            
            // Abrir modal de nova tarefa
            document.getElementById('newTaskBtn').addEventListener('click', () => {
                openTaskModal();
            });
            
            // Fechar modal de tarefa
            document.getElementById('closeTaskModal').addEventListener('click', () => {
                document.getElementById('taskModal').classList.add('hidden');
            });
            
            document.getElementById('cancelTask').addEventListener('click', () => {
                document.getElementById('taskModal').classList.add('hidden');
            });
            
            // Fechar modal de detalhes da tarefa
            document.getElementById('closeTaskDetailsModal').addEventListener('click', () => {
                document.getElementById('taskDetailsModal').classList.add('hidden');
            });
            
            // Formulário de tarefa
            document.getElementById('taskForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const taskId = document.getElementById('taskId').value;
                const isEditing = !!taskId;
                
                const formData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    projectId: document.getElementById('taskProject').value,
                    priority: document.getElementById('taskPriority').value,
                    status: document.getElementById('taskStatus').value,
                    dueDate: document.getElementById('taskDueDate').value || null
                };
                
                try {
                    let response;
                    
                    if (isEditing) {
                        // Atualizar tarefa existente
                        response = await fetch(`/api/tasks/${taskId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${auth.getToken()}`
                            },
                            body: JSON.stringify(formData)
                        });
                    } else {
                        // Criar nova tarefa
                        response = await fetch('/api/tasks', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${auth.getToken()}`
                            },
                            body: JSON.stringify(formData)
                        });
                    }
                    
                    if (!response.ok) {
                        throw new Error(`Falha ao ${isEditing ? 'atualizar' : 'criar'} tarefa`);
                    }
                    
                    // Fechar modal
                    document.getElementById('taskModal').classList.add('hidden');
                    
                    // Limpar formulário
                    document.getElementById('taskForm').reset();
                    
                    // Recarregar tarefas
                    await loadTasks();
                    
                } catch (error) {
                    console.error(`Erro ao ${isEditing ? 'atualizar' : 'criar'} tarefa:`, error);
                    alert(`Erro ao ${isEditing ? 'atualizar' : 'criar'} tarefa. Por favor, tente novamente.`);
                }
            });
            
            // Filtros
            document.getElementById('searchTasks').addEventListener('input', filterTasks);
            document.getElementById('filterProject').addEventListener('change', filterTasks);
            document.getElementById('filterPriority').addEventListener('change', filterTasks);
        }
        
        // Carregar projetos para o filtro e para o formulário
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects', {
                    headers: {
                        'Authorization': `Bearer ${auth.getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Falha ao carregar projetos');
                }
                
                const projects = await response.json();
                
                // Preencher select de projetos no filtro
                const filterProjectSelect = document.getElementById('filterProject');
                filterProjectSelect.innerHTML = '<option value="">Todos os projetos</option>';
                
                // Preencher select de projetos no formulário
                const taskProjectSelect = document.getElementById('taskProject');
                taskProjectSelect.innerHTML = '<option value="">Selecione um projeto</option>';
                
                projects.forEach(project => {
                    // Adicionar ao filtro
                    const filterOption = document.createElement('option');
                    filterOption.value = project.id;
                    filterOption.textContent = project.name;
                    filterProjectSelect.appendChild(filterOption);
                    
                    // Adicionar ao formulário
                    const formOption = document.createElement('option');
                    formOption.value = project.id;
                    formOption.textContent = project.name;
                    taskProjectSelect.appendChild(formOption);
                });
                
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
            }
        }
        
        // Carregar tarefas
        async function loadTasks() {
            try {
                // Limpar colunas
                document.getElementById('todo-tasks').innerHTML = '';
                document.getElementById('in-progress-tasks').innerHTML = '';
                document.getElementById('done-tasks').innerHTML = '';
                
                // Buscar tarefas
                const response = await fetch('/api/tasks', {
                    headers: {
                        'Authorization': `Bearer ${auth.getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Falha ao carregar tarefas');
                }
                
                const tasks = await response.json();
                
                // Buscar projetos para exibir o nome do projeto em cada tarefa
                const projectsResponse = await fetch('/api/projects', {
                    headers: {
                        'Authorization': `Bearer ${auth.getToken()}`
                    }
                });
                
                let projects = [];
                if (projectsResponse.ok) {
                    projects = await projectsResponse.json();
                }
                
                // Criar mapa de projetos para fácil acesso
                const projectsMap = {};
                projects.forEach(project => {
                    projectsMap[project.id] = project;
                });
                
                // Agrupar tarefas por status
                const tasksByStatus = {
                    'todo': [],
                    'in-progress': [],
                    'done': []
                };
                
                tasks.forEach(task => {
                    if (tasksByStatus[task.status]) {
                        tasksByStatus[task.status].push(task);
                    } else {
                        tasksByStatus.todo.push(task);
                    }
                });
                
                // Atualizar contadores
                document.getElementById('todo-count').textContent = tasksByStatus.todo.length;
                document.getElementById('in-progress-count').textContent = tasksByStatus['in-progress'].length;
                document.getElementById('done-count').textContent = tasksByStatus.done.length;
                
                // Renderizar tarefas em cada coluna
                renderTasksInColumn('todo-tasks', tasksByStatus.todo, projectsMap);
                renderTasksInColumn('in-progress-tasks', tasksByStatus['in-progress'], projectsMap);
                renderTasksInColumn('done-tasks', tasksByStatus.done, projectsMap);
                
                // Configurar drag and drop
                setupDragAndDrop();
                
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                
                // Exibir mensagem de erro em cada coluna
                const errorMessage = `
                    <div class="text-center py-8">
                        <i class="ph ph-warning text-4xl text-yellow-500 mb-2"></i>
                        <p class="text-grayText">Erro ao carregar tarefas. Por favor, tente novamente.</p>
                    </div>
                `;
                
                document.getElementById('todo-tasks').innerHTML = errorMessage;
                document.getElementById('in-progress-tasks').innerHTML = errorMessage;
                document.getElementById('done-tasks').innerHTML = errorMessage;
            }
        }
        
        // Renderizar tarefas em uma coluna
        function renderTasksInColumn(columnId, tasks, projectsMap) {
            const column = document.getElementById(columnId);
            
            if (!tasks || tasks.length === 0) {
                column.innerHTML = `
                    <div class="text-center py-8 text-grayText">
                        <i class="ph ph-clipboard-text text-3xl mb-2"></i>
                        <p>Nenhuma tarefa</p>
                    </div>
                `;
                return;
            }
            
            column.innerHTML = tasks.map(task => {
                // Obter nome do projeto
                const project = projectsMap[task.projectId] || { name: 'Projeto Desconhecido' };
                
                // Formatar data de entrega
                let dueDateDisplay = '';
                if (task.dueDate) {
                    const dueDate = new Date(task.dueDate);
                    const today = new Date();
                    const tomorrow = new Date();
                    tomorrow.setDate(today.getDate() + 1);
                    
                    // Verificar se é hoje, amanhã ou outra data
                    if (dueDate.toDateString() === today.toDateString()) {
                        dueDateDisplay = `<span class="text-yellow-300">Hoje</span>`;
                    } else if (dueDate.toDateString() === tomorrow.toDateString()) {
                        dueDateDisplay = `<span class="text-yellow-300">Amanhã</span>`;
                    } else if (dueDate < today) {
                        dueDateDisplay = `<span class="text-red-400">Atrasado (${dueDate.toLocaleDateString('pt-BR')})</span>`;
                    } else {
                        dueDateDisplay = dueDate.toLocaleDateString('pt-BR');
                    }
                }
                
                return `
                    <div class="task-card" draggable="true" data-task-id="${task.id}" data-status="${task.status}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-medium">${task.title}</h3>
                            <span class="priority-${task.priority} text-xs px-2 py-1 rounded-full border">
                                ${getPriorityLabel(task.priority)}
                            </span>
                        </div>
                        <p class="text-sm text-grayText mb-3 line-clamp-2">${task.description || 'Sem descrição'}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xs bg-darkBg px-2 py-1 rounded-full">${project.name}</span>
                            ${dueDateDisplay ? `
                                <span class="text-xs flex items-center">
                                    <i class="ph ph-clock mr-1"></i> ${dueDateDisplay}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Adicionar evento de clique para ver detalhes
            column.querySelectorAll('.task-card').forEach(card => {
                card.addEventListener('click', () => {
                    const taskId = card.dataset.taskId;
                    viewTaskDetails(taskId);
                });
            });
        }
        
        // Configurar drag and drop
        function setupDragAndDrop() {
            const taskCards = document.querySelectorAll('.task-card');
            const dropZones = document.querySelectorAll('.task-list');
            
            taskCards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', card.dataset.taskId);
                    setTimeout(() => {
                        card.classList.add('opacity-50');
                    }, 0);
                });
                
                card.addEventListener('dragend', () => {
                    card.classList.remove('opacity-50');
                });
            });
            
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('bg-darkBorder/30');
                });
                
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('bg-darkBorder/30');
                });
                
                zone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    zone.classList.remove('bg-darkBorder/30');
                    
                    const taskId = e.dataTransfer.getData('text/plain');
                    const newStatus = zone.id.split('-')[0]; // todo, in-progress, done
                    
                    try {
                        const response = await fetch(`/api/tasks/${taskId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${auth.getToken()}`
                            },
                            body: JSON.stringify({ status: newStatus })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Falha ao atualizar status da tarefa');
                        }
                        
                        // Recarregar tarefas
                        await loadTasks();
                        
                    } catch (error) {
                        console.error('Erro ao atualizar status da tarefa:', error);
                        alert('Erro ao mover tarefa. Por favor, tente novamente.');
                    }
                });
            });
        }
        
        // Filtrar tarefas
        function filterTasks() {
            const searchTerm = document.getElementById('searchTasks').value.toLowerCase();
            const projectFilter = document.getElementById('filterProject').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            
            const taskCards = document.querySelectorAll('.task-card');
            
            taskCards.forEach(card => {
                const taskTitle = card.querySelector('h3').textContent.toLowerCase();
                const taskDescription = card.querySelector('p').textContent.toLowerCase();
                const projectName = card.querySelector('.bg-darkBg').textContent.toLowerCase();
                const priority = card.querySelector('[class^="priority-"]').className.split('priority-')[1].split(' ')[0];
                
                const matchesSearch = taskTitle.includes(searchTerm) || taskDescription.includes(searchTerm);
                const matchesProject = !projectFilter || card.dataset.projectId === projectFilter;
                const matchesPriority = !priorityFilter || priority === priorityFilter;
                
                if (matchesSearch && matchesProject && matchesPriority) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
            
            // Atualizar contadores
            updateCounters();
        }
        
        // Atualizar contadores após filtro
        function updateCounters() {
            const todoCount = document.querySelectorAll('#todo-tasks .task-card:not(.hidden)').length;
            const inProgressCount = document.querySelectorAll('#in-progress-tasks .task-card:not(.hidden)').length;
            const doneCount = document.querySelectorAll('#done-tasks .task-card:not(.hidden)').length;
            
            document.getElementById('todo-count').textContent = todoCount;
            document.getElementById('in-progress-count').textContent = inProgressCount;
            document.getElementById('done-count').textContent = doneCount;
        }
        
        // Abrir modal de tarefa (nova ou edição)
        function openTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const modalTitle = document.getElementById('taskModalTitle');
            const saveButton = document.getElementById('saveTaskBtn');
            
            // Limpar formulário
            form.reset();
            
            if (taskId) {
                // Modo de edição
                modalTitle.textContent = 'Editar Tarefa';
                saveButton.textContent = 'Salvar Alterações';
                
                // Carregar dados da tarefa
                loadTaskData(taskId);
            } else {
                // Modo de criação
                modalTitle.textContent = 'Nova Tarefa';
                saveButton.textContent = 'Criar Tarefa';
                document.getElementById('taskId').value = '';
            }
            
            // Mostrar modal
            modal.classList.remove('hidden');
        }
        
        // Carregar dados da tarefa para edição
        async function loadTaskData(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    headers: {
                        'Authorization': `Bearer ${auth.getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Falha ao carregar dados da tarefa');
                }
                
                const task = await response.json();
                
                // Preencher formulário
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskProject').value = task.projectId;
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskStatus').value = task.status;
                
                if (task.dueDate) {
                    // Formatar data para o formato esperado pelo input date (YYYY-MM-DD)
                    const dueDate = new Date(task.dueDate);
                    const formattedDate = dueDate.toISOString().split('T')[0];
                    document.getElementById('taskDueDate').value = formattedDate;
                } else {
                    document.getElementById('taskDueDate').value = '';
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados da tarefa:', error);
                alert('Erro ao carregar dados da tarefa. Por favor, tente novamente.');
                
                // Fechar modal
                document.getElementById('taskModal').classList.add('hidden');
            }
        }
        
        // Ver detalhes da tarefa
        async function viewTaskDetails(taskId) {
            try {
                // Mostrar modal com loading
                const modal = document.getElementById('taskDetailsModal');
                modal.classList.remove('hidden');
                
                document.getElementById('taskDetailsContent').innerHTML = `
                    <div class="animate-pulse">
                        <div class="h-6 bg-darkBg rounded w-3/4 mb-4"></div>
                        <div class="h-4 bg-darkBg rounded w-1/2 mb-2"></div>
                        <div class="h-4 bg-darkBg rounded w-full mb-4"></div>
                        <div class="h-32 bg-darkBg rounded w-full mb-4"></div>
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao carregar dados da tarefa:', error);
                alert('Erro ao carregar dados da tarefa. Por favor, tente novamente.');
                
                // Fechar modal
                document.getElementById('taskDetailsModal').classList.add('hidden');
            }
        }
    </script>
</body>
</html>